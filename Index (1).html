<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistem Hafazan - Vercel Final</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:16px;background:#f7fafc;color:#0f172a}
    h1,h2{color:#0b57a4}
    form{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 1px 3px rgba(2,6,23,0.08)}
    input,textarea,select{width:100%;padding:8px;margin:6px 0;border:1px solid #e2e8f0;border-radius:6px}
    button{background:#0b57a4;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
    table{width:100%;border-collapse:collapse;background:#fff;margin-bottom:16px}
    th,td{border:1px solid #e2e8f0;padding:8px;text-align:left}
    th{background:#0b57a4;color:#fff}
    .flex{display:flex;gap:8px}
    .half{flex:1}
    .note{font-size:13px;color:#334155}
    #supabase-toast{position:fixed;right:16px;top:16px;z-index:9999}
    #supabase-toast > div{margin-top:8px;padding:8px 12px;border-radius:6px;box-shadow:0 2px 6px rgba(2,6,23,0.08)}
    img.hidden{display:none}
  </style>
</head>
<body>
  <h1>Sistem Hafazan - Dashboard</h1>

  <section id="settings-section">
    <form id="settings-form">
      <h2>Tetapan Institusi</h2>
      <label>Nama Institusi</label>
      <input name="institusi_nama" id="namaInstitusiInput" placeholder="Nama institusi..." />
      <div class="flex">
        <div class="half">
          <label>Logo (preview)</label>
          <img id="logoDisplay" class="hidden" style="max-width:100%;height:80px;display:block" />
          <input type="file" id="upload-logo-storage" accept="image/*" />
        </div>
        <div class="half">
          <label>Wallpaper (preview)</label>
          <img id="wallpaperDisplay" class="hidden" style="max-width:100%;height:80px;display:block" />
          <input type="file" id="upload-wallpaper-storage" accept="image/*" />
        </div>
      </div>
      <div style="margin-top:8px">
        <button type="button" id="saveButton">Simpan Tetapan</button>
      </div>
    </form>
  </section>

  <!-- Example forms for other tables -->
  <form id="hafazan-form">
    <h2>Rekod Hafazan</h2>
    <input name="nama-pelajar" placeholder="Nama pelajar" />
    <input name="no-kad-pelajar" placeholder="No kad" />
    <input name="kelas" placeholder="Kelas" />
    <input name="jenis-hafalan" placeholder="Jenis hafalan" />
    <input name="surah" placeholder="Surah" />
    <input name="keputusan" placeholder="Keputusan" />
    <input name="ustaz-tasmik" placeholder="Ustaz" />
    <textarea name="catatan-ustaz" placeholder="Catatan"></textarea>
    <button type="submit">Simpan Hafazan</button>
  </form>

  <form id="prestasi-form">
    <h2>Rekod Prestasi</h2>
    <input name="prestasi-nama" placeholder="Nama pelajar" />
    <input name="prestasi-no-kad" placeholder="No kad" />
    <input name="prestasi-tarikh" type="date" />
    <input name="prestasi-hari" placeholder="Hari" />
    <input name="prestasi-surah" placeholder="Surah" />
    <input name="prestasi-keputusan" placeholder="Keputusan" />
    <textarea name="prestasi-catatan" placeholder="Catatan"></textarea>
    <button type="submit">Simpan Prestasi</button>
  </form>

  <form id="disiplin-form">
    <h2>Rekod Disiplin</h2>
    <input name="disiplin-nama" placeholder="Nama pelajar" />
    <input name="disiplin-no-kad" placeholder="No kad" />
    <input name="disiplin-tarikh" type="date" />
    <textarea name="disiplin-laporan-guru" placeholder="Laporan guru"></textarea>
    <button type="submit">Simpan Disiplin</button>
  </form>

  <form id="pencapaian-form">
    <h2>Pencapaian</h2>
    <input name="pencapaian-nama" placeholder="Nama pelajar" />
    <input name="pencapaian-no-kad" placeholder="No kad" />
    <input name="pencapaian-tarikh" type="date" />
    <input name="pencapaian-jenis" placeholder="Jenis" />
    <input name="pencapaian-hadiah" placeholder="Hadiah" />
    <button type="submit">Simpan Pencapaian</button>
  </form>

  <form id="aktiviti-form">
    <h2>Aktiviti</h2>
    <input name="aktiviti-nama" placeholder="Nama aktiviti" />
    <input name="aktiviti-tarikh" type="date" />
    <input name="aktiviti-lokasi" placeholder="Lokasi" />
    <textarea name="aktiviti-keterangan" placeholder="Keterangan"></textarea>
    <button type="submit">Simpan Aktiviti</button>
  </form>

  <form id="pelajar-form">
    <h2>Pelajar</h2>
    <input name="pelajar-nama" placeholder="Nama pelajar" />
    <input name="pelajar-no-kad" placeholder="No kad" />
    <input name="pelajar-kelas" placeholder="Kelas" />
    <button type="submit">Simpan Pelajar</button>
  </form>

  <section>
    <h2>Senarai Rekod</h2>
    <h3>Hafazan</h3>
    <table><thead><tr><th>Tarikh</th><th>Nama</th><th>No Kad</th><th>Kelas</th><th>Jenis</th><th>Surah</th></tr></thead><tbody id="hafazan-records"></tbody></table>
    <h3>Prestasi</h3>
    <table><thead><tr><th>Tarikh</th><th>Nama</th><th>No Kad</th><th>Surah</th><th>Prestasi</th></tr></thead><tbody id="prestasi-records"></tbody></table>
    <h3>Disiplin</h3>
    <table><thead><tr><th>Tarikh</th><th>Nama</th><th>No Kad</th><th>Laporan</th></tr></thead><tbody id="disiplin-records"></tbody></table>
    <h3>Pencapaian</h3>
    <table><thead><tr><th>Tarikh</th><th>Nama</th><th>No Kad</th><th>Jenis</th></tr></thead><tbody id="pencapaian-records"></tbody></table>
    <h3>Pelajar</h3>
    <table><thead><tr><th>Nama</th><th>No Kad</th><th>Kelas</th></tr></thead><tbody id="pelajar-records"></tbody></table>
  </section>

  <div id="supabase-toast"></div>

<script>
/* ----------------- Universal Supabase loader ----------------- */
(function loadSupabaseLibrary(){
  const cdn = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
  const script = document.createElement('script');
  script.src = cdn;
  script.defer = true;
  script.onload = () => {
    console.log("Supabase library loaded");
    try {
      const SUPABASE_URL = "https://onkmfvyhzikgkisfeuuc.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ua21mdnloemlrZ2tpc2ZldXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODIxNjYsImV4cCI6MjA3NjY1ODE2Nn0.WxtGk1_8-YNWuW7_5oXDgum-KeqdQ0HN_6kST9PP7Zk";
      window.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      console.log("Supabase client ready");
      initApp();
    } catch (e){
      console.error("Supabase init failed", e);
      notify("Sambungan Supabase gagal", "error");
    }
  };
  script.onerror = () => {
    console.error("Failed loading Supabase library");
    notify("Gagal muat pustaka Supabase", "error");
  };
  document.head.appendChild(script);
})();

/* ----------------- Utilities ----------------- */
function notify(msg, type='info'){
  const c = document.getElementById('supabase-toast');
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.background = type==='error' ? '#fee2e2' : type==='success' ? '#ecfccb' : '#e6f2ff';
  el.style.color = '#0f172a';
  el.style.padding='8px 12px';
  el.style.borderRadius='6px';
  c.prepend(el);
  setTimeout(()=>el.remove(),4000);
}
function debounce(fn,wait=800){let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),wait);};}
function toDbKey(name){ return name.replace(/-/g,'_'); }
function safeStr(v){ return v===null||v===undefined?'':v; }

/* ----------------- App core ----------------- */
function initApp(){
  const BUCKET = 'fail_web';
  const FOLDER = 'tetapan';

  const FORM_TABLE_MAP = {
    "hafazan-form":"hafazan_records",
    "prestasi-form":"prestasi_records",
    "disiplin-form":"disiplin_records",
    "pencapaian-form":"pencapaian_records",
    "aktiviti-form":"aktiviti_records",
    "pelajar-form":"pelajar_records",
    "settings-form":"settings",
    "system_health-form":"system_health"
  };

  // Offline queue for retries
  const retryQueue = [];

  async function uploadFileToBucket(file, prefix){
    if(!file) return null;
    const ext = file.name.split('.').pop();
    const safe = (prefix||'file').replace(/[^a-z0-9_\-]/gi,'').toLowerCase();
    const path = `${FOLDER}/${safe}_${Date.now()}.${ext}`;
    try{
      const { error } = await supabase.storage.from(BUCKET).upload(path, file, { upsert:true });
      if(error){ throw error; }
      const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
      return data.publicUrl;
    }catch(err){
      console.error('uploadFileToBucket err',err);
      retryQueue.push({type:'upload',file,prefix});
      notify('Gagal muat naik. Dicuba semula kemudian','error');
      return null;
    }
  }

  async function saveForm(formEl, tableName){
    const fd = new FormData(formEl);
    const payload = {};
    fd.forEach((v,k)=> payload[toDbKey(k)] = v===''?null:v);
    payload.updated_at = new Date().toISOString();
    let onConflict = null;
    if(payload.no_kad) onConflict=['no_kad'];
    else if(payload.id) onConflict=['id'];
    try{
      let res;
      if(onConflict) res = await supabase.from(tableName).upsert([payload], { onConflict });
      else res = await supabase.from(tableName).insert([payload]);
      if(res.error){ throw res.error; }
      notify(`AutoSaved → ${tableName}`,'success');
      // refresh one row in table display
      refreshLatestRow(tableName);
      return true;
    }catch(err){
      console.error('saveForm err',err);
      retryQueue.push({type:'save',formHtml:formEl.outerHTML,table:tableName});
      notify('Gagal simpan — akan cuba semula','error');
      return false;
    }
  }

  function attachAutoSave(){
    Object.entries(FORM_TABLE_MAP).forEach(([formId,tableName])=>{
      const form = document.getElementById(formId); if(!form) return;
      const handler = debounce(()=> saveForm(form,tableName),900);
      form.querySelectorAll('input,textarea,select').forEach(el=>{
        el.addEventListener('input', handler);
        el.addEventListener('change', handler);
        el.addEventListener('paste', handler);
      });
      form.addEventListener('submit',(e)=>{ e.preventDefault(); saveForm(form,tableName); });
    });
  }

  async function populateForms(){
    for(const [formId,tableName] of Object.entries(FORM_TABLE_MAP)){
      const form = document.getElementById(formId); if(!form) continue;
      const hasValue = Array.from(form.querySelectorAll('input,textarea,select')).some(i=>i.value && i.value.trim()!==''); if(hasValue) continue;
      // try fetch latest
      try{
        const { data, error } = await supabase.from(tableName).select('*').order('updated_at',{ascending:false}).limit(1);
        if(error || !data || data.length===0) continue;
        const record = data[0];
        form.querySelectorAll('input,textarea,select').forEach(el=>{
          const name = el.getAttribute('name'); if(!name) return;
          const key = toDbKey(name);
          if(record[key]!==undefined && record[key]!==null) el.value = record[key];
        });
      }catch(err){ console.error('populateForms err',err); }
    }
  }

  async function muatSemuaData(){
    const map = {
      hafazan_records:'hafazan-records',
      prestasi_records:'prestasi-records',
      disiplin_records:'disiplin-records',
      pencapaian_records:'pencapaian-records',
      aktiviti_records:'aktiviti-records',
      pelajar_records:'pelajar-records'
    };
    for(const [tableName,tbodyId] of Object.entries(map)){
      const tbody = document.getElementById(tbodyId); if(!tbody) continue;
      try{
        const { data, error } = await supabase.from(tableName).select('*').order('updated_at',{ascending:false}).limit(200);
        if(error) { console.warn('muatSemuaData err',tableName,error); continue; }
        tbody.innerHTML='';
        data.forEach(r=>{
          const tr = document.createElement('tr');
          const vals = Object.keys(r).slice(0,6).map(k=>safeStr(r[k]));
          tr.innerHTML = vals.map(v=>`<td>${v}</td>`).join('');
          tbody.appendChild(tr);
        });
      }catch(err){ console.error('muatSemuaData exception',err); }
    }
  }

  async function refreshLatestRow(tableName){
    const map = {
      hafazan_records:'hafazan-records',
      prestasi_records:'prestasi-records',
      disiplin_records:'disiplin-records',
      pencapaian_records:'pencapaian-records',
      aktiviti_records:'aktiviti-records',
      pelajar_records:'pelajar-records'
    };
    const tbodyId = map[tableName]; if(!tbodyId) return;
    const tbody = document.getElementById(tbodyId); if(!tbody) return;
    try{
      const { data, error } = await supabase.from(tableName).select('*').order('updated_at',{ascending:false}).limit(1);
      if(error || !data || data.length===0) return;
      const r = data[0];
      const tr = document.createElement('tr');
      const vals = Object.keys(r).slice(0,6).map(k=>safeStr(r[k]));
      tr.innerHTML = vals.map(v=>`<td>${v}</td>`).join('');
      tbody.prepend(tr);
    }catch(err){ console.error('refreshLatestRow err',err); }
  }

  // settings specific (upload logo/wallpaper then upsert settings row id=1)
  async function loadSettings(){
    try{
      const { data, error } = await supabase.from('settings').select('*').eq('id',1).single();
      if(!error && data){
        document.getElementById('namaInstitusiInput').value = data.institusi_nama || '';
        if(data.logo_url){ const img=document.getElementById('logoDisplay'); img.src=data.logo_url; img.style.display='block'; }
        if(data.wallpaper_url){ const wp=document.getElementById('wallpaperDisplay'); wp.src=data.wallpaper_url; wp.style.display='block'; document.body.style.backgroundImage = `url('${data.wallpaper_url}')`; }
      }
    }catch(err){ console.error('loadSettings err',err); }
  }

  // save settings handler
  const saveBtn = document.getElementById('saveButton');
  if(saveBtn){
    saveBtn.addEventListener('click', async ()=>{
      try{
        saveBtn.disabled=true; notify('Memproses...','info');
        const name = document.getElementById('namaInstitusiInput').value || '';
        const logoFile = document.getElementById('upload-logo-storage').files?.[0] || null;
        const wallFile = document.getElementById('upload-wallpaper-storage').files?.[0] || null;
        let logoUrl=null, wallUrl=null;
        if(logoFile) logoUrl = await uploadFileToBucket(logoFile,'logo');
        if(wallFile) wallUrl = await uploadFileToBucket(wallFile,'wall');
        const payload = { id:1, institusi_nama: name };
        if(logoUrl) payload.logo_url = logoUrl;
        if(wallUrl) payload.wallpaper_url = wallUrl;
        const { error } = await supabase.from('settings').upsert(payload, { onConflict:'id' });
        if(error) { throw error; }
        notify('Tetapan disimpan','success');
        await loadSettings();
      }catch(err){ console.error('save settings err',err); notify('Gagal simpan tetapan','error'); }
      finally{ saveBtn.disabled=false; }
    });
  }

  // previews for local inputs
  const logoInput = document.getElementById('upload-logo-storage');
  if(logoInput) logoInput.addEventListener('change',(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ const img=document.getElementById('logoDisplay'); img.src=ev.target.result; img.style.display='block'; }; r.readAsDataURL(f); });
  const wallInput = document.getElementById('upload-wallpaper-storage');
  if(wallInput) wallInput.addEventListener('change',(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ const img=document.getElementById('wallpaperDisplay'); img.src=ev.target.result; img.style.display='block'; document.body.style.backgroundImage=`url('${ev.target.result}')`; }; r.readAsDataURL(f); });

  // attach autosave & initial load
  attachAutoSave();
  populateForms();
  muatSemuaData();
  loadSettings();

  // simple retry loop for queued actions (every 10s)
  setInterval(async ()=>{
    if(retryQueue.length===0) return;
    const item = retryQueue.shift();
    try{
      if(item.type==='upload') await uploadFileToBucket(item.file,item.prefix);
      if(item.type==='save'){
        // best-effort: notify user to manually resave
        notify('Ada item simpan belum selesai. Sila semak.');
      }
    }catch(e){ console.error('retry error',e); }
  },10000);
} // end initApp
</script>
</body>
</html>
